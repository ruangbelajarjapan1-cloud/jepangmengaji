<!doctype html>
<html lang="id" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Arsip â€” Jepang Mengaji</title>
  <link rel="icon" href="jm.jpeg"/>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    [data-theme="light"]{--bg:#fff;--card:#fff;--border:#e2e8f0;--text:#0f172a;--muted:#475569;--primary:#3b82f6}
    [data-theme="dark"]{--bg:#0f172a;--card:#111827;--border:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--primary:#3b82f6}
    body{background:var(--bg);color:var(--text)}
    .container{max-width:960px;margin:0 auto;padding:1rem}
    h1,h2{margin:.5rem 0}
    .tabs{display:flex;gap:.5rem;margin:1rem 0}
    .btn{padding:.4rem .8rem;border:1px solid var(--border);border-radius:.5rem;background:var(--card);cursor:pointer}
    .btn.active{background:var(--primary);color:#fff}
    input{width:100%;padding:.5rem;border:1px solid var(--border);border-radius:.5rem}
    .grid{display:grid;gap:1rem}
    .grid-3{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:.7rem;padding:.8rem}
    .muted{color:var(--muted);font-size:.9rem}
    .video-thumb img{width:100%;border-radius:.5rem}
    footer{margin:2rem 0;text-align:center;color:var(--muted);font-size:.85rem}
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ“š Arsip Jepang Mengaji</h2>
    <div class="tabs">
      <button class="btn active" id="tabVideo">Video</button>
      <button class="btn" id="tabArtikel">Artikel</button>
      <span id="count" class="muted" style="margin-left:auto">0 item</span>
    </div>
    <input id="q" type="search" placeholder="Cari (contoh: akidah, fiqih, tauhid, ramadhan)â€¦"/>
    <div style="margin:1rem 0"></div>

    <div id="videoList" class="grid grid-3"></div>
    <div id="articleList" class="grid grid-3" style="display:none"></div>

    <footer>Â© <span id="year"></span> Jepang Mengaji</footer>
  </div>

<script>
  const CHANNEL_ID="UC3h0lpsfwETKD9v2mY6WVTQ";
  const YT_RSS_PRIMARY=`https://cors.isomorphic-git.org/https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}`;
  const YT_RSS_FALLBACK=`https://r.jina.ai/http://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}`;
  const ARTICLES_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQiIOueuc-YygpdulT9x9ZjJUA2jlaWXu2uGzwgHcugNebW5HLjR66luq3kHmqDvTmNJlSjpjsIQ6PG/pub?gid=0&single=true&output=csv";

  let allVideos=[],allArticles=[];

  // === fetch YouTube RSS
  async function fetchYouTubeRSS(){
    try{
      const res=await fetch(YT_RSS_PRIMARY+`&_=${Date.now()}`);
      if(!res.ok) throw new Error("bad");
      const xml=await res.text();
      return parseXML(xml);
    }catch(e){
      console.warn("primary gagal, coba fallback:",e);
    }
    const res2=await fetch(YT_RSS_FALLBACK+`&_=${Date.now()}`);
    const xml2=await res2.text();
    return parseXML(xml2);
  }
  function parseXML(xml){
    const doc=new DOMParser().parseFromString(xml,"text/xml");
    return [...doc.querySelectorAll("entry")].map(e=>{
      const id=(e.querySelector("yt\\:videoId, videoId")||{}).textContent||"";
      return {
        id,
        title:(e.querySelector("title")||{}).textContent||"",
        published:new Date((e.querySelector("published")||{}).textContent||""),
        link:`https://www.youtube.com/watch?v=${id}`,
        thumb:`https://i.ytimg.com/vi/${id}/hqdefault.jpg`,
        desc:(e.querySelector("media\\:description, description")||{}).textContent||""
      };
    }).sort((a,b)=>b.published-a.published);
  }

  // === fetch CSV artikel
  async function fetchCSV(url){
    const res=await fetch(url);
    const text=(await res.text()).replace(/^\uFEFF/,"");
    const rows=[];let row=[],cell="",inQuotes=false;
    for(let i=0;i<text.length;i++){
      const c=text[i],n=text[i+1];
      if(c=='"'){ if(inQuotes&&n=='"'){cell+='"';i++;} else inQuotes=!inQuotes; }
      else if(c===','&&!inQuotes){row.push(cell);cell='';}
      else if((c==='\n'||(c==='\r'&&n==='\n'))&&!inQuotes){ if(c==='\r') i++; row.push(cell);cell=''; if(row.length) rows.push(row); row=[];}
      else { cell+=c; }
    }
    if(cell||row.length){row.push(cell);rows.push(row);}
    const header=(rows.shift()||[]).map(h=>h.trim());
    return rows.map(r=>Object.fromEntries(header.map((h,i)=>[h,(r[i]||"").trim()])));
  }

  function renderVideos(list){
    const wrap=document.getElementById("videoList");
    wrap.innerHTML="";
    if(!list.length){wrap.innerHTML='<div class="muted">Belum ada video.</div>';return}
    list.forEach(v=>{
      const card=document.createElement("div");card.className="card";
      card.innerHTML=`<div class="video-thumb"><a href="${v.link}" target="_blank" rel="noopener"><img src="${v.thumb}" alt="${v.title}"></a></div>
      <h3>${v.title}</h3><div class="muted">${v.published.toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric"})}</div>`;
      wrap.appendChild(card);
    });
  }
  function renderArticles(list){
    const wrap=document.getElementById("articleList");
    wrap.innerHTML="";
    if(!list.length){wrap.innerHTML='<div class="muted">Belum ada artikel.</div>';return}
    list.forEach(a=>{
      const card=document.createElement("div");card.className="card";
      card.innerHTML=`<h3>${a.title||""}</h3><p class="muted">${a.excerpt||""}</p>
      <div class="muted">${a.date?new Date(a.date).toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric"}):""}</div>
      <a class="btn" href="${a.href||"#"}" target="_blank">Baca</a>`;
      wrap.appendChild(card);
    });
  }
  function updateCount(){
    const active=document.getElementById("tabVideo").classList.contains("active")?"video":"artikel";
    const n=active==="video"?allVideos.length:allArticles.length;
    document.getElementById("count").textContent=n+" item";
  }

  // === init
  (async()=>{
    document.getElementById("year").textContent=new Date().getFullYear();
    [allVideos,allArticles]=await Promise.all([fetchYouTubeRSS(),fetchCSV(ARTICLES_CSV_URL)]);
    renderVideos(allVideos);renderArticles(allArticles);updateCount();

    // tab switch
    document.getElementById("tabVideo").onclick=()=>{
      document.getElementById("tabVideo").classList.add("active");
      document.getElementById("tabArtikel").classList.remove("active");
      document.getElementById("videoList").style.display="grid";
      document.getElementById("articleList").style.display="none";updateCount();
    };
    document.getElementById("tabArtikel").onclick=()=>{
      document.getElementById("tabArtikel").classList.add("active");
      document.getElementById("tabVideo").classList.remove("active");
      document.getElementById("videoList").style.display="none";
      document.getElementById("articleList").style.display="grid";updateCount();
    };

    // search
    const qBox=document.getElementById("q");
    qBox.addEventListener("input",()=>{
      const q=qBox.value.toLowerCase();
      const videos=allVideos.filter(v=>(v.title+v.desc).toLowerCase().includes(q));
      const arts=allArticles.filter(a=>(a.title+a.excerpt).toLowerCase().includes(q));
      renderVideos(videos);renderArticles(arts);updateCount();
    });

    // prefill ?q=
    const params=new URLSearchParams(location.search);
    const initQ=params.get("q")||"";
    if(initQ){
      qBox.value=initQ;
      qBox.dispatchEvent(new Event("input"));
    }
  })();
</script>
</body>
</html>
