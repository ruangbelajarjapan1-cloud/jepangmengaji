<!doctype html>
<html lang="id" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Arsip ‚Äî Jepang Mengaji</title>
  <link rel="icon" href="jm.jpeg"/>
  <style>
    :root{--bg:#0f172a;--soft:#111827;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--primary:#3b82f6}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1120px;margin:0 auto;padding:1.25rem}
    header{display:flex;align-items:center;gap:.6rem;padding:.5rem 0;flex-wrap:wrap}
    header img{height:32px;border-radius:.4rem}
    .card{background:var(--soft);border:1px solid var(--border);border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .p{padding:1rem}
    .grid{display:grid;gap:1rem}
    @media(min-width:768px){.grid-3{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:repeat(2,1fr)}}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .85rem;border:1px solid var(--border);border-radius:.65rem;background:#0b1220;color:var(--text);text-decoration:none;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .tabbar{display:flex;gap:.4rem;flex-wrap:wrap}
    .tab{padding:.4rem .7rem;border:1px solid var(--border);border-radius:.6rem;background:#0b1220;cursor:pointer}
    .tab.active{background:var(--primary);border-color:var(--primary);color:#fff}
    .pill{padding:.15rem .5rem;border:1px solid var(--border);border-radius:999px;font-size:.75rem;color:var(--muted)}
    input[type="search"]{width:100%;padding:.7rem .9rem;border:1px solid var(--border);border-radius:.7rem;background:#0b1220;color:var(--text)}
    .video-thumb{border-radius:.7rem;overflow:hidden;border:1px solid var(--border)}
    .center{display:flex;justify-content:center;align-items:center}
    footer{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;color:var(--muted);flex-wrap:wrap;gap:.5rem}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="jm.jpeg" alt="JM"/>
      <strong>Arsip Jepang Mengaji</strong>
      <nav style="margin-left:auto;display:flex;gap:.6rem;flex-wrap:wrap">
        <a class="btn" href="index.html">üè† Home</a>
        <a class="btn" href="live.html">üî¥ Live</a>
        <a class="btn primary" href="https://www.youtube.com/@jepangmengaji1390" target="_blank" rel="noopener">‚ñ∂Ô∏è YouTube</a>
      </nav>
    </header>

    <div style="margin:1rem 0">
      <a class="btn" href="index.html">‚¨Ö Back to Home</a>
    </div>

    <section class="card">
      <div class="p">
        <div class="tabbar" role="tablist" aria-label="Kategori arsip">
          <button class="tab active" data-tab="videos" role="tab" aria-selected="true">Video</button>
          <button class="tab" data-tab="articles" role="tab" aria-selected="false">Artikel</button>
          <span class="pill" id="countInfo">0 item</span>
        </div>
        <div style="height:.75rem"></div>
        <input id="q" type="search" placeholder="Cari (contoh: akidah, fiqih, tauhid, ramadhan)..." aria-label="Cari video & artikel"/>
      </div>
    </section>

    <section id="videos" class="card" style="margin-top:1rem">
      <div class="p">
        <h2 style="margin:.2rem 0 1rem">Video YouTube</h2>
        <div id="videoList" class="grid grid-3"></div>
        <div class="center" style="margin-top:1rem">
          <button id="loadMore" class="btn" style="display:none">Muat lagi</button>
        </div>
        <div id="videoError" class="muted" style="margin-top:.75rem;display:none"></div>
      </div>
    </section>

    <section id="articles" class="card" style="margin-top:1rem;display:none">
      <div class="p">
        <h2 style="margin:.2rem 0 1rem">Artikel</h2>
        <div id="articleList" class="grid grid-2"></div>
      </div>
    </section>

    <footer>
      <span>¬© <span id="y"></span> Jepang Mengaji</span>
      <a class="btn" href="index.html">‚¨Ö Back to Home</a>
      <a class="muted" href="#top">Kembali ke atas</a>
    </footer>
  </div>

<script>
  // ===== KONFIG =====
  const CHANNEL_ID = "UC3h0lpsfwETKD9v2mY6WVTQ";
  const FEED_URL = `https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}`;

  // >>> MODE ‚ÄúSEMUA VIDEO‚Äù AKTIF (API key kamu)
  const YT_API_KEY = "AIzaSyD4Uvf7iCGGuaoAbUeHhxTJcV6GuyRKw-k";
  const UPLOADS_PLAYLIST_ID = "UU" + CHANNEL_ID.slice(2);

  const ARTICLES_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQiIOueuc-YygpdulT9x9ZjJUA2jlaWXu2uGzwgHcugNebW5HLjR66luq3kHmqDvTmNJlSjpjsIQ6PG/pub?gid=0&single=true&output=csv";

  document.getElementById('y').textContent=new Date().getFullYear();

  // ===== Tabs =====
  const tabs=document.querySelectorAll('.tab');
  const secVideos=document.getElementById('videos');
  const secArticles=document.getElementById('articles');
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const isVideos = t.dataset.tab==='videos';
    secVideos.style.display = isVideos?'block':'none';
    secArticles.style.display = isVideos?'none':'block';
    updateCount();
  }));

  // ===== Util & Render =====
  let allVideos=[], allArticles=[];
  let ytNextPageToken=null;

  function fmtDate(d){ return d ? d.toLocaleDateString('id-ID',{year:'numeric',month:'short',day:'numeric'}) : '' }
  function updateCount(){
    const activeTab = document.querySelector('.tab.active')?.dataset.tab || 'videos';
    const n = activeTab==='videos' ? document.querySelectorAll('#videoList > *').length
                                   : document.querySelectorAll('#articleList > *').length;
    document.getElementById('countInfo').textContent = `${n} item`;
  }
  function showVideoError(msg){
    const el=document.getElementById('videoError');
    el.textContent = msg;
    el.style.display = 'block';
  }
  function renderVideosAppend(list){
    const wrap=document.getElementById('videoList');
    list.forEach(v=>{
      const a=document.createElement('a'); a.className='card'; a.href=v.link; a.target='_blank'; a.rel='noopener';
      const p=document.createElement('div'); p.className='p';
      p.innerHTML = `
        <div class="video-thumb"><img src="${v.thumb}" alt=""></div>
        <h3 style="margin:.6rem 0 .3rem">${v.title}</h3>
        <div class="muted">${fmtDate(v.published)}</div>`;
      a.appendChild(p); wrap.appendChild(a);
    });
  }
  function resetVideosUI(){ document.getElementById('videoList').innerHTML=''; document.getElementById('videoError').style.display='none'; }

  // ====== MODE API (SEMUA VIDEO) ======
  async function fetchUploadsPage(pageToken=null){
    const url = new URL("https://www.googleapis.com/youtube/v3/playlistItems");
    url.searchParams.set("part","snippet,contentDetails");
    url.searchParams.set("playlistId",UPLOADS_PLAYLIST_ID);
    url.searchParams.set("maxResults","24"); // bisa 50
    url.searchParams.set("key",YT_API_KEY);
    if(pageToken) url.searchParams.set("pageToken",pageToken);

    const res = await fetch(url.toString());
    if(!res.ok){ throw new Error('YouTube API error '+res.status); }
    const json = await res.json();
    ytNextPageToken = json.nextPageToken || null;

    const items = (json.items||[]).map(it=>{
      const id = (it.contentDetails && it.contentDetails.videoId) || "";
      return {
        id,
        title: it.snippet?.title || "",
        published: new Date(it.contentDetails?.videoPublishedAt || it.snippet?.publishedAt || Date.now()),
        link: `https://www.youtube.com/watch?v=${id}`,
        thumb: `https://i.ytimg.com/vi/${id}/hqdefault.jpg`,
        desc: it.snippet?.description || ""
      };
    });
    return items;
  }

  // ====== MODE TANPA API (fallback RSS) ======
  async function fetchFeedNoKey(){
    const candidates = [
      FEED_URL,
      `https://api.allorigins.win/raw?url=${encodeURIComponent(FEED_URL)}`,
      `https://cors.isomorphic-git.org/${FEED_URL}`
    ];
    for(const u of candidates){
      try{
        const res = await fetch(u, {headers:{'Accept':'application/xml,text/xml,application/xhtml+xml;q=0.9,*/*;q=0.8'}});
        const txt = await res.text();
        const doc = new DOMParser().parseFromString(txt, "text/xml");
        const entries = Array.from(doc.getElementsByTagName('entry'));
        if(entries.length){
          const list = entries.map(e=>{
            const link = (e.getElementsByTagName('link')[0]?.getAttribute('href')) || '';
            const id   = (link.split('v=')[1]||'').slice(0,11);
            const title= e.getElementsByTagName('title')[0]?.textContent || '';
            const published = new Date(e.getElementsByTagName('published')[0]?.textContent || Date.now());
            return { id, title, published, link: link || `https://www.youtube.com/watch?v=${id}`, thumb:`https://i.ytimg.com/vi/${id}/hqdefault.jpg`, desc:'' };
          }).sort((a,b)=>b.published-a.published);
          return list;
        }
      }catch(err){
        console.warn('Feed gagal:', u, err);
      }
    }
    return [];
  }

  async function initVideos(){
    resetVideosUI();
    try{
      if (YT_API_KEY){
        const first = await fetchUploadsPage(null);
        allVideos = first.slice().sort((a,b)=>b.published-a.published);
        renderVideosAppend(allVideos);
        document.getElementById('loadMore').style.display = ytNextPageToken ? 'inline-flex':'none';
        if(!allVideos.length) showVideoError('Tidak ada video dari API.');
      }else{
        allVideos = await fetchFeedNoKey();
        renderVideosAppend(allVideos);
        document.getElementById('loadMore').style.display='none';
        if(!allVideos.length) showVideoError('Gagal memuat video. Coba refresh atau isi API key.');
      }
      updateCount();
    }catch(e){
      console.error(e);
      showVideoError('Terjadi kesalahan saat memuat video.');
    }
  }

  document.getElementById('loadMore').addEventListener('click', async ()=>{
    if(!YT_API_KEY || !ytNextPageToken) return;
    try{
      const more = await fetchUploadsPage(ytNextPageToken);
      allVideos = allVideos.concat(more).sort((a,b)=>b.published-a.published);
      renderVideosAppend(more);
      document.getElementById('loadMore').style.display = ytNextPageToken ? 'inline-flex':'none';
      updateCount();
    }catch(e){
      console.error(e);
      showVideoError('Gagal memuat halaman berikutnya.');
    }
  });

  // ===== Artikel (CSV) =====
  async function fetchCSV(url){
    const res=await fetch(url+(url.includes('?')?'&':'?')+'_='+Date.now());
    const text=(await res.text()).replace(/^\uFEFF/,'');
    const rows=[];let row=[],cell='',inQuotes=false;
    for(let i=0;i<text.length;i++){
      const c=text[i],n=text[i+1];
      if(c=='"'){ if(inQuotes&&n=='"'){cell+='"';i++;} else inQuotes=!inQuotes; }
      else if(c===','&&!inQuotes){row.push(cell);cell='';}
      else if((c==='\n'||(c==='\r'&&n==='\n'))&&!inQuotes){ if(c==='\r') i++; row.push(cell); cell=''; if(row.length) rows.push(row); row=[]; }
      else { cell+=c; }
    }
    if(cell||row.length){row.push(cell);rows.push(row)}
    const header=(rows.shift()||[]).map(h=>h.trim());
    return rows.map(r=>Object.fromEntries(header.map((h,i)=>[h,(r[i]||'').trim()])));
  }
  function renderArticles(list){
    const wrap=document.getElementById('articleList'); wrap.innerHTML='';
    if(!list.length){wrap.innerHTML='<div class="muted">Belum ada artikel.</div>';return}
    list.forEach(a=>{
      const card=document.createElement('article'); card.className='card';
      const p=document.createElement('div'); p.className='p';
      p.innerHTML = `<h3>${a.title||''}</h3>
        <p class="muted">${a.excerpt||''}</p>
        <div class="muted">${a.date?fmtDate(new Date(a.date)):''}</div>
        <a class="btn" href="${a.href||'#'}" target="_blank" rel="noopener">Baca</a>`;
      card.appendChild(p); wrap.appendChild(card);
    });
  }

  // ===== Search =====
  document.getElementById('q').addEventListener('input', e=>{
    const q=e.target.value.toLowerCase();
    const vFiltered = allVideos.filter(v => (v.title+' '+v.desc).toLowerCase().includes(q));
    const aFiltered = allArticles.filter(a => (a.title+' '+(a.excerpt||'')).toLowerCase().includes(q));
    document.getElementById('videoList').innerHTML='';
    renderVideosAppend(vFiltered);
    renderArticles(aFiltered);
    updateCount();
  });

  // ===== Init =====
  (async ()=>{
    try{
      [allArticles] = await Promise.all([ fetchCSV(ARTICLES_CSV_URL) ]);
      renderArticles(allArticles);
      await initVideos();
      const params=new URLSearchParams(location.search);
      const initQ=params.get('q')||'';
      if(initQ){ const box=document.getElementById('q'); box.value=initQ; box.dispatchEvent(new Event('input')); }
    }catch(err){
      console.error(err);
      showVideoError('Gagal memuat data.');
    }
  })();
</script>
</body>
</html>
